package com.example.bank;

import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class AccountServiceImpl {

    @Autowired
    private AccountDaoImpl accountDao; 

    @Transactional
    public void createAccount(String accountHolder, double balance) {
        Account account = new Account(accountHolder, balance);
        accountDao.createAccount(account);
    }

    @Transactional(readOnly = true)
    public Account getAccount(int id) {
        return accountDao.getAccountById(id);
    }

    @Transactional
public void transferMoney(int fromAccountId, int toAccountId, double amount) {
        Account fromAccount = accountDao.getAccountById(fromAccountId);
        Account toAccount = accountDao.getAccountById(toAccountId);

        if (fromAccount.getBalance() < amount) {
            throw new RuntimeException("Insufficient funds in account " + fromAccountId);
        }

        fromAccount.setBalance(fromAccount.getBalance() - amount);
        toAccount.setBalance(toAccount.getBalance() + amount);

        accountDao.updateAccount(fromAccount);
        accountDao.updateAccount(toAccount);
        
        Transaction txLog = new Transaction(fromAccountId, toAccountId, amount);
        accountDao.logTransaction(txLog);
    }
}

@Repository
class AccountDaoImpl {

    @Autowired
    private SessionFactory sessionFactory;

    public void createAccount(Account account) {
        Session session = sessionFactory.getCurrentSession();
        session.save(account);
    }

    public Account getAccountById(int id) {
        Session session = sessionFactory.getCurrentSession();
        return session.get(Account.class, id);
    }

    public void updateAccount(Account account) {
        Session session = sessionFactory.getCurrentSession();
        session.update(account);
    }

    public void logTransaction(Transaction transaction) {
        Session session = sessionFactory.getCurrentSession();
        session.save(transaction);
    }
}
